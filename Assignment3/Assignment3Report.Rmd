---
title: "Diamond Price Estimation"
author: "Ebru Gecici"
date: "06 09 2020"
output: 
  html_document:
    number_sections: true
    code_folding: hide
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: '3'
  word_document:
    toc: yes
    toc_depth: '3'
---

<style>
body{
  color: #708090 ;
  font-family: Calibri Light;
  background-color: #F5F5F5;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center", message=FALSE, warning=FALSE)
st = "Diamond Dataset from ggplot2" 
```

# Diamonds

Diamonds are the hardest element found in nature and their atoms are arranged crystal structure. Moreover, diamonds are one of the most popular and preferable jewelry. They, on the other hand, are one of the most expensive jewelry. Thus, the characteristics of the diamond are very important to define price. According to the [Yadav Diamond](https://www.yadavjewelry.com/info/diamond-education/your-complete-diamond-characteristics-guide#:~:text=Actually%20diamond%20has%20four%20main,they%20affect%20the%20diamond's%20price.) information, there are four important features. They are called *4C*. Especially, these 4C's of diamond constitutes the vast majority of the price.

- **Carat**: The carat is the weight of the diamond and this weight is important for the diamond
  + One carat is equal to 1/5 of a gram
  + One carat is divided into a hundred equal points
  
- **Color**: This feature give the color feature into the diamond.
  + Grade range of D to F has colorless diamonds. Moreover, the value of these type of diamonds is higher than the others
  + Diamonds, which have lower than F, are also shine. But these diamonds have strong color tones
  + A factor which is related with color is named as Fluorescence which is caused by boron trace amount inside the diamond. Fluorescence is activated by ultraviolet light. It is believed that a diamond with intense fluorescence has positive effect. 
  + [Colors](https://www.bluenile.com/education/diamonds/color):
    + Colorless Diamonds,the rarest and highest quality with a pure icy look, **D-F Color Diamonds**
    + Near-colorless diamonds: No discernible color; great value for the quality, **G-H Color Diamonds** and **I-J Color Diamonds**
    + Faint color diamonds: Budget-friendly pick; pairs beautifully with yellow gold, **K Color Diamonds**

<center>

![](https://beyond4cs.com/wp-content/uploads/2019/02/diamond-color-chart-with-example-diamonds-of-each-alphabet.jpg){#id .class width=500 height=250px}

Figure 1. Color classification of the diamonds

</center>

- **Clarity**: Clarity defines the extent or degree of imperfections that are present in a diamond.There is 11 point diamond clarity scale that is creating by Gemologist Institute of America or GIA. his scale starts from flawless point and ends at prominent inclusions. Flawless means a diamond with no inclusion. This diamond is extremely rare.

<center>

![](https://www.ringcommend.com.au/wp-content/uploads/2020/02/Diamond-Clarity.jpg){#id .class width=600 height=200}

Figure 2. Classification of Diamonds by Clarity 

</center>

- **Cut**: Cut is the most important characteristic of the diamond. 
  + It determines how the light which enters into the diamond from the above will be reflected back to the eye of observer 
  + A perfect cut diamond reflects light to its optimum
  
<center>
![](https://diamondbuzz.blog/wp-content/uploads/2019/05/Diamond-Cut-Grades.jpg){#id .class width=300 height=200}

Figure 3. Quality of Cut

</center>

# Data and Required Packages

## Data Information

In this [assignment](https://mef-bda503.github.io/archive/fall17/files/assignment_diamonds_data.html), there are few objective to improve data analysis skills. These objectives can be listed as follow:

1. To provide useful exploratory data analysis (EDA) by using visuals and tables
2. To present a model for estimation of the diamond price

To fulfill these objectives, (i) data is analyzed and prepared for creating prediction model and analysis, (ii) the meaningful EDA is presented by using some useful packages such as `ggplot2`, `dplyr`, `tidyverse` etc.

*Note that this packages are used to prepare EDA, if more packages are required, they are installed and loaded when they are required.*

```{r required packages}
library(tidyverse) # used for data analyses
#as the tidyverse includes ggplot2 and dplyr packages, we do not need to add these packages additionally.
library(ggplot2) # for visualization
library(dplyr)   # to make calculations 
library(tm) # provides a set of predefined sources
library(knitr) # to provide report creation
library(kableExtra) # to provide arrangement of the tables
```

The dataset in this analysis is obtained from the `ggplot2` packages. Before the load this data set. By using `?diamonds` we can obtain information about this dataset. This data set contains more than 50.000 round cut diamonds, whose features like are located in this data set. There are 53940 rows and 10 variables. By using this `glimpse()` function, we obtain these variables.

```{r}
#while we load ggplot2 package, we get directly diamonds dataset by following line
#we assign our data set to diamonds for more easy use
diamonds <- diamonds 
head(diamonds)
```

```{r}
#variables of the dataset
diamonds %>%
  glimpse()
```
Moreover same results can be obtained by using  `str()` function which comes from the Base R.

```{r}
diamonds %>%
  str()
```



Since we check the order of the variables of color categorical variable, there is wrong order,i.e., the D is actually the best color in the explanation, on the other hand, it is the worst in the data set. Moreover, when we search the data in the internet, we can obtain that the explanation is true. For this reason, to interpret correctly, by using following code we can rearrange the order.

```{r}
diamonds$color <- factor(diamonds$color, levels = c("J", "I", "H", "G", "F", "E", "D"))
```

**Price**: price in US dollars (\$326–\$18,823)<br>
**Carat**: weight of the diamond (0.2–5.01)<br>
**Cut**: quality of the cut (Fair, Good, Very Good, Premium, Ideal)<br>
**Color**: diamond color, from D (best) to J (worst)<br>
**Clarity**: a measurement of how clear the diamond is I1 (worst), SI2, SI1, VS2, VS1, VVS2, VVS1, IF (best)<br>
**x**: length in mm (0–10.74)<br>
**y**: width in mm (0–58.9)<br>
**z**: depth in mm (0–31.8)<br>
**Depth**: total depth percentage = z / mean(x, y) = 2 * z / (x + y) (43–79)<br>
**Table**: width of top of diamond relative to widest point (43–95)<br>

## Data Preprocessing

In the previous section, detailed information about investigated dataset is presented. In this section, the data is analyzed or pre-processed before the detailed analyses.

```{r}
#to control NA values in the dataset
sum(any(is.na(diamonds)))
```

When we check the dataset, there is `r sum(any(is.na(diamonds)))` NA value. This means that there is no missing value in any row or column.

```{r}
sum(as.numeric(duplicated(diamonds)))
```
By using above function we can obtain number of NA values in this dataset. Another important control point is that checking of the duplicated values. There are `r sum(as.numeric(duplicated(diamonds)))` duplicated lines. Before the analysis, we need to  extract these data from the data frame. Because these duplicated values can manipulate our analysis, for example one of the duplicated value go to train data set, the other one can be in the test data. As a result, the same value become in both data set and this can prevent the good prediction. For this reason, duplicated values should be removed fromthe data set. This process can be made by using various function, i.e., `duplicated()`, `unique()`, and `distinct()`. In this assignment, the *`unique()`* function is used.


```{r}
#taking only unique rows form the data set
diamonds <- unique(diamonds)
#control of the duplicated lines after removing of the duplicated lines
sum(as.numeric(duplicated(diamonds)))
```
According to the usage of `unique()`function, there is no duplicated line. As a results, we have `r nrow(diamonds)` rows and `r ncol(diamonds)` columns. While the rows show that the number of trials, the columns give the number of variables/features in the dataset.
After this process, we can use `summary()` function and `head()` function to get more information about the dataset.

```{r}
summary(diamonds) # summary of each variable in the dataset
head(diamonds) #first 6 rows of the data
```

## Accuracy of the Values

We can control the negative price values in the data set.

```{r}
diamonds %>%
  filter(price <= 0) %>%
  summarise(NegativePrice = n())
```

Logically, price should be greater than zero. For this reason, we check dataset to control negative price values. According to the results there is no negative price value. This is the expected situation. 
Moreover, we can control accuracy of the data by using other variables. According to the research results, the relationship between x,y,z and depth can be found. In other words, the depth variable is obtain from the calculation which is obtained by using x,y, and z variable. This explanation also can be obtain from the R package explanation by using `?diamonds`.

The calculation is that

total depth percentage = z / mean(x, y) <br>
                       = 2 * z / (x + y)

According to the this calculation, the depth variable and x,y,z variables are compared and outliers or manipulated data can be removed. For this purpose following calculations and visualizations are made.

```{r, fig.align=75%}
#by using ggplot function, we can realize the relationship between x and y.
#it is expected that there linear relationship between these two variable. 
diamonds %>%
  ggplot(., aes(x = x, y = y)) + 
  geom_point() + 
  geom_smooth(method = "lm", color = "red") + # provide adding smooth line for data
  theme_minimal() +
  labs(title = "Comparison of the x and y variable",
       x = "X variable",
       y = "Y variable")
```

Although there are a few outliers, the most of the data shows that there is a linear relationship between x and y variables.
Same analysis can be made with other variables:

```{r}
diamonds %>%
  ggplot(., aes(x = z, y = y)) + #comparison of the z and y variables
  geom_point() + 
  geom_smooth(method = "lm", color = "red")+ # provide adding smooth line for data
  theme_minimal() +
  labs(title = "Comparison of the x and y variable",
       x = "Z variable",
       y = "Y variable")
```

There are also outliers but still the linear relationship can be found between z and y variables.
According to the this analysis, we can say that linear relationship can be obtained between x and z variables.

Another accuracy control about finding the correcting entering variable is that to find the zero values of the x,y, and z variables. As mentioned before, we can find depth variable by using given formulation. By using this formulation, we can detect the wrong entered variables. Before this examination, we can check the zero values:

```{r}
diamonds %>%
  filter(x == 0 & y != 0 & z !=0) # provide to find x variables which is zero whereas the y and z is greater than zero

diamonds %>%
  filter(y == 0 & x != 0 & z !=0) # provide to find y variables which is zero whereas the x and z is greater than zero

diamonds %>%
  filter(z == 0 & x != 0 & y !=0) # provide to find z variables which is zero whereas the x and y is greater than zero
```

Results show that, there is no value which has x=0 and the y and z are greater than zero. Like this calculations, same filtration can be used other two variables. 

Only z variable has missing value when the x and y have values. For this reason by using depth formulation we can fill the missing value of the z. 

```{r}
diamonds = diamonds %>%
  mutate(z = ifelse(z == 0 & x != 0 & y != 0,round(depth * mean(c(x, y)) / 100, 2), z))

#re-control of the z missing values.
diamonds %>%
  filter(z == 0 & x != 0 & y !=0) # provide to find z variables which is zero whereas the x and y is 
```

If the two of them are missing, we cannot control the acuracy of the data. For this reason, we need to remove this data from the dataset.

```{r}
#control of two of them.
diamonds %>%
  filter(x == 0 & y == 0)

diamonds %>%
  filter(x == 0 & z == 0)

diamonds %>%
  filter(y == 0 & z == 0)
```


##### Buraya Açıklama Eklenecek!!!!!!!!!!

```{r}
diamonds = diamonds %>%
  filter(!(x == 0 & z == 0))

diamonds %>%
  filter(x == 0 | y == 0 | z == 0)
```

By using following code, we can calculate own depth variables as calculate and then we can compare to check accuracy.

```{r}
diamonds$calculate = 2 * diamonds$z / (diamonds$x + diamonds$y) * 100
```


```{r,include false}
#difference between minimum and maximum values
range(diamonds$x)
range(diamonds$y)
sort(unique(diamonds$y), decreasing = TRUE) %>%
  head

#since there is huge difference between minimum and maximum values of y, we can find this data from the data set by using following code.
diamonds %>%
  filter(y > 15)

#after the finding of this values,which can be wrong entered data, we can change this values by using depth and x, and z variables 
diamonds %>%
  filter(y > 15) %>%
  mutate(new_y = (2 * z / depth) / 100 - x) %>%
  select(depth, x, z, y, new_y)

#finding of small values
diamonds = diamonds %>%
  filter(y < 15)

range(diamonds$z)
```

```{r}
# another way of finding outliers of dataset
# visualization
diamonds %>%
  filter(x != 0 & y != 0 & z != 0) %>%
  ggplot(., aes(x = calculate, y = depth)) +
  geom_point() + 
  geom_abline(intercept = 0, slope = 1, color="red", 
              linetype="dashed", size=1.5) +
  theme_minimal() +
  labs(title = "Comparison of the depth and calculated depth",
       x = "Calculated depth",
       y = "Depth (given in the dataset)")
```


As the same calculation is used, we expect that the strong relationship between calculated depth and depth given in the dataset. This relationship should be in the linear line if the given data are true.
Results show that, all of the data do not illustrate the linear relationship, there are some outliers. One of them is far from the linear smoothing line. This data should be removed from the dataset. Before the removing of the data, we check all data.

```{r}
diamonds[which.max(diamonds$calculate),]
diamonds[abs(diamonds$x - 5) < 1 & abs(diamonds$y - 5) < 1,]
```

```{r}
#finding outlier, this data shows the extreme point for the z variable
diamonds %>%
  filter(z == 31.8) %>%
  mutate(new_z = depth * mean(c(5.12, 5.15)) / 100) %>%
  select(z, new_z)

diamonds$calculate[diamonds$z == 31.8] = diamonds$calculate[diamonds$z == 31.8] / 10
diamonds$z[diamonds$z == 31.8] = diamonds$z[diamonds$z == 31.8] / 10
```

```{r}
diamonds %>%
  filter(!(abs(calculate - depth) < 11)) %>%
  select(calculate, depth, x, y, z)
```

